<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IoT Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }

        .dashboard-container {
            max-width: 100vw;
            overflow-x: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background-color: white;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chart-wrapper {
            min-width: 2000px;
            height: 400px;
            position: relative;
        }

        .chart-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .debug-info {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
        }

        .error {
            color: #d32f2f;
            font-weight: bold;
            background: #ffebee;
            padding: 10px;
            border-radius: 4px;
        }

        .success {
            color: #388e3c;
            font-weight: bold;
            background: #e8f5e8;
            padding: 10px;
            border-radius: 4px;
        }

        .reload-btn {
            padding: 12px 24px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 0;
            font-size: 14px;
            transition: background 0.3s;
        }

        .reload-btn:hover {
            background: #1976d2;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2196f3;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>IoT Sensor Dashboard</h1>

    <div class="controls">
        <button class="reload-btn" onclick="loadAllCharts()">Reload All Charts</button>
        <div style="flex-grow: 1;"></div>
        <div>
            <label>
                <input type="checkbox" id="smoothLines" checked onchange="updateCharts()"> Smooth Lines
            </label>
        </div>
    </div>

    <div id="debugInfo"></div>

    <div id="statsContainer" class="stats"></div>

    <!-- Temperature Chart -->
    <div class="dashboard-container">
        <div class="chart-title">üå°Ô∏è Temperature Monitoring</div>
        <div class="chart-wrapper">
            <canvas id="tempChart"></canvas>
        </div>
    </div>

    <!-- CO2 Chart -->
    <div class="dashboard-container">
        <div class="chart-title">‚ö†Ô∏è CO (Carbon Monoxide) Levels</div>
        <div class="chart-wrapper">
            <canvas id="coChart"></canvas>
        </div>
    </div>

    <!-- Humidity Chart -->
    <div class="dashboard-container">
        <div class="chart-title">üíß Humidity Monitoring</div>
        <div class="chart-wrapper">
            <canvas id="humidityChart"></canvas>
        </div>
    </div>

    <script>
        let chartData = null;
        let tempChartInstance = null;
        let coChartInstance = null;
        let humidityChartInstance = null;

        async function loadAllCharts() {
            const debugInfo = document.getElementById('debugInfo');

            try {
                debugInfo.innerHTML = '<div>Loading sensor data...</div>';

                const response = await fetch("/api/data");
                const data = await response.json();

                console.log("Sensor data received:", data);

                chartData = data;

                if (Object.keys(data).length === 0) {
                    debugInfo.innerHTML = `<div class="error">No sensor data available</div>`;
                    return;
                }

                // Create all charts
                createTemperatureChart();
                createCOChart();
                createHumidityChart();
                updateStatistics();

                debugInfo.innerHTML = `<div class="success">
                    Dashboard loaded successfully!<br>
                    Devices: ${Object.keys(data).join(', ')}<br>
                    Total records: ${Object.keys(data).reduce((sum, device) => sum + data[device].timestamps.length, 0)}
                </div>`;

            } catch (error) {
                console.error('Error loading charts:', error);
                debugInfo.innerHTML = `<div class="error">Error loading data: ${error.message}</div>`;
            }
        }

        function createTemperatureChart() {
            if (!chartData) return;

            const ctx = document.getElementById("tempChart").getContext("2d");
            if (tempChartInstance) {
                tempChartInstance.destroy();
            }

            const canvas = document.getElementById("tempChart");
            canvas.width = 2000;
            canvas.height = 400;

            const datasets = [];
            const deviceColors = {
                'b8:27:eb:bf:9d:51': '#ff4444',
                '00:0f:00:70:91:0a': '#ff6b35',
                '1c:bf:ce:15:ec:4d': '#ffa726'
            };

            for (const [device, values] of Object.entries(chartData)) {
                if (values.timestamps && values.timestamps.length > 0 && values.temp) {
                    const color = deviceColors[device] || '#888888';
                    const dataPoints = [];

                    for (let i = 0; i < Math.min(values.timestamps.length, 1000); i++) { // Limit points for performance
                        const dt = luxon.DateTime.fromISO(values.timestamps[i]);
                        if (dt.isValid) {
                            dataPoints.push({
                                x: dt.toISO(),
                                y: values.temp[i]
                            });
                        }
                    }

                    datasets.push({
                        label: `${device} - Temperature`,
                        data: dataPoints,
                        borderColor: color,
                        backgroundColor: color + '40',
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 1,
                        tension: document.getElementById('smoothLines').checked ? 0.4 : 0
                    });
                }
            }

            if (datasets.length > 0) {
                tempChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: { datasets },
                    options: getChartOptions('Temperature (¬∞C)')
                });
            }
        }

        function createCOChart() {
            if (!chartData) return;

            const ctx = document.getElementById("coChart").getContext("2d");
            if (coChartInstance) {
                coChartInstance.destroy();
            }

            const canvas = document.getElementById("coChart");
            canvas.width = 2000;
            canvas.height = 400;

            const datasets = [];
            const deviceColors = {
                'b8:27:eb:bf:9d:51': '#d32f2f',
                '00:0f:00:70:91:0a': '#f44336',
                '1c:bf:ce:15:ec:4d': '#ef5350'
            };

            for (const [device, values] of Object.entries(chartData)) {
                if (values.timestamps && values.timestamps.length > 0 && values.co) {
                    const color = deviceColors[device] || '#888888';
                    const dataPoints = [];

                    for (let i = 0; i < Math.min(values.timestamps.length, 1000); i++) {
                        const dt = luxon.DateTime.fromISO(values.timestamps[i]);
                        if (dt.isValid) {
                            dataPoints.push({
                                x: dt.toISO(),
                                y: values.co[i]
                            });
                        }
                    }

                    datasets.push({
                        label: `${device} - CO`,
                        data: dataPoints,
                        borderColor: color,
                        backgroundColor: color + '40',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 1,
                        tension: document.getElementById('smoothLines').checked ? 0.4 : 0
                    });
                }
            }

            if (datasets.length > 0) {
                coChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: { datasets },
                    options: getChartOptions('CO Level')
                });
            }
        }

        function createHumidityChart() {
            if (!chartData) return;

            const ctx = document.getElementById("humidityChart").getContext("2d");
            if (humidityChartInstance) {
                humidityChartInstance.destroy();
            }

            const canvas = document.getElementById("humidityChart");
            canvas.width = 2000;
            canvas.height = 400;

            const datasets = [];
            const deviceColors = {
                'b8:27:eb:bf:9d:51': '#1976d2',
                '00:0f:00:70:91:0a': '#42a5f5',
                '1c:bf:ce:15:ec:4d': '#90caf9'
            };

            for (const [device, values] of Object.entries(chartData)) {
                if (values.timestamps && values.timestamps.length > 0 && values.humidity) {
                    const color = deviceColors[device] || '#888888';
                    const dataPoints = [];

                    for (let i = 0; i < Math.min(values.timestamps.length, 1000); i++) {
                        const dt = luxon.DateTime.fromISO(values.timestamps[i]);
                        if (dt.isValid) {
                            dataPoints.push({
                                x: dt.toISO(),
                                y: values.humidity[i]
                            });
                        }
                    }

                    datasets.push({
                        label: `${device} - Humidity`,
                        data: dataPoints,
                        borderColor: color,
                        backgroundColor: color + '40',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 1,
                        tension: document.getElementById('smoothLines').checked ? 0.4 : 0
                    });
                }
            }

            if (datasets.length > 0) {
                humidityChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: { datasets },
                    options: getChartOptions('Humidity (%)')
                });
            }
        }

        function getChartOptions(yAxisTitle) {
            return {
                responsive: false,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            tooltipFormat: 'yyyy-MM-dd HH:mm:ss',
                            displayFormats: {
                                day: 'MMM dd'
                            }
                        },
                        title: {
                            display: true,
                            text: "Time",
                            font: { size: 14, weight: 'bold' }
                        },
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: yAxisTitle,
                            font: { size: 14, weight: 'bold' }
                        },
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            font: { size: 12 },
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0,0,0,0.8)'
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            };
        }

        function updateStatistics() {
            if (!chartData) return;

            const statsContainer = document.getElementById('statsContainer');
            let statsHTML = '';

            for (const [device, values] of Object.entries(chartData)) {
                if (values.temp && values.temp.length > 0) {
                    const avgTemp = (values.temp.reduce((a, b) => a + b, 0) / values.temp.length).toFixed(1);
                    const avgHumidity = (values.humidity.reduce((a, b) => a + b, 0) / values.humidity.length).toFixed(1);
                    const avgCO = (values.co.reduce((a, b) => a + b, 0) / values.co.length).toFixed(6);

                    statsHTML += `
                        <div class="stat-card">
                            <div class="stat-label">Device: ${device}</div>
                            <div class="stat-value">${avgTemp}¬∞C</div>
                            <div class="stat-label">Avg Temperature</div>
                            <div class="stat-value">${avgHumidity}%</div>
                            <div class="stat-label">Avg Humidity</div>
                            <div class="stat-value">${avgCO}</div>
                            <div class="stat-label">Avg CO Level</div>
                        </div>
                    `;
                }
            }

            statsContainer.innerHTML = statsHTML;
        }

        function updateCharts() {
            createTemperatureChart();
            createCOChart();
            createHumidityChart();
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', loadAllCharts);
    </script>
</body>
</html>