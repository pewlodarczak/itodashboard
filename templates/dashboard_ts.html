<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IoT Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }

        .dashboard-container {
            max-width: 100vw;
            overflow-x: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            background-color: #f9f9f9;
            margin-bottom: 20px;
        }

        .chart-wrapper {
            min-width: 2000px;
            height: 500px;
            position: relative;
        }

        .debug-info {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
        }

        .error {
            color: red;
            font-weight: bold;
        }

        .success {
            color: green;
            font-weight: bold;
        }

        .reload-btn {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
        }

        .reload-btn:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h2>IoT Time Series Dashboard</h2>

    <button class="reload-btn" onclick="loadChart()">Reload Chart</button>

    <div id="debugInfo"></div>

    <div class="dashboard-container">
        <div class="chart-wrapper">
            <canvas id="chart"></canvas>
        </div>
    </div>

    <script>
        let myChart = null;
        let chartData = null;

        async function loadChart() {
            console.log("loadChart function called");
            const debugInfo = document.getElementById('debugInfo');

            try {
                debugInfo.innerHTML = '<div>Loading data...</div>';

                // Load the actual chart data
                const response = await fetch("/api/data");
                const data = await response.json();

                console.log("Chart data received:", data);

                // Store data for later use
                chartData = data;

                // Check if data is empty
                if (Object.keys(data).length === 0) {
                    debugInfo.innerHTML = `<div class="error">No device data returned from /api/data</div>`;
                    return;
                }

                // Create and display the chart
                createChart();

                debugInfo.innerHTML = `<div class="success">
                    Chart loaded successfully!<br>
                    Devices: ${Object.keys(data).join(', ')}<br>
                    Total data points: ${Object.keys(data).reduce((sum, device) => sum + data[device].timestamps.length, 0)}
                </div>`;

            } catch (error) {
                console.error('Error loading chart:', error);
                debugInfo.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        function createChart() {
            if (!chartData) {
                console.error("No chart data available");
                return;
            }

            const ctx = document.getElementById("chart").getContext("2d");

            // Destroy existing chart if it exists
            if (myChart) {
                myChart.destroy();
                myChart = null;
            }

            // Set canvas dimensions
            const canvas = document.getElementById("chart");
            canvas.width = 2000;
            canvas.height = 500;

            console.log("Creating chart with data:", chartData);

            const datasets = [];
            const deviceColors = {
                'b8:27:eb:bf:9d:51': '#ff4444',
                '00:0f:00:70:91:0a': '#4444ff',
                '1c:bf:ce:15:ec:4d': '#44ff44'
            };

            // Create temperature datasets
            for (const [device, values] of Object.entries(chartData)) {
                if (values.timestamps && values.timestamps.length > 0 && values.temp) {
                    const color = deviceColors[device] || '#888888';

                    const dataPoints = [];
                    for (let i = 0; i < values.timestamps.length; i++) {
                        // Use Luxon to parse the timestamp properly
                        const dt = luxon.DateTime.fromISO(values.timestamps[i]);
                        dataPoints.push({
                            x: dt.toISO(), // Ensure proper ISO format
                            y: values.temp[i]
                        });
                    }

                    datasets.push({
                        label: `Temp (${device})`,
                        data: dataPoints,
                        borderColor: color,
                        backgroundColor: color + '20',
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 1,
                        tension: 0.1
                    });
                }
            }

            console.log("Datasets prepared:", datasets);

            if (datasets.length === 0) {
                document.getElementById('debugInfo').innerHTML +=
                    '<div class="error">No valid data points to display</div>';
                return;
            }

            try {
                myChart = new Chart(ctx, {
                    type: 'line',
                    data: { datasets },
                    options: {
                        responsive: false,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'day',
                                    tooltipFormat: 'yyyy-MM-dd HH:mm:ss'
                                },
                                title: {
                                    display: true,
                                    text: "Timestamp"
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: "Temperature (Â°C)"
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        }
                    }
                });

                console.log("Chart created successfully");

            } catch (chartError) {
                console.error("Chart creation error:", chartError);
                document.getElementById('debugInfo').innerHTML +=
                    `<div class="error">Chart error: ${chartError.message}</div>`;
            }
        }

        // Load chart when page is ready - but only once
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM loaded, initializing chart");
            loadChart();
        });
    </script>
</body>
</html>